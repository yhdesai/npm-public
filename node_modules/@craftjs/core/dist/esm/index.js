import{EventHandlers as e,DerivedEventHandlers as n,ERROR_USE_EDITOR_OUTSIDE_OF_EDITOR_CONTEXT as t,useCollector as r,wrapConnectorHooks as o,RenderIndicator as a,getDOMInfo as d,ERROR_USE_NODE_OUTSIDE_OF_EDITOR_CONTEXT as i,deprecationWarning as s,useEffectOnce as u,ERROR_TOP_LEVEL_ELEMENT_NO_ID as c,ROOT_NODE as l,ERROR_DELETE_TOP_LEVEL_NODE as f,ERROR_INVALID_NODEID as p,ERROR_NOPARENT as v,DEPRECATED_ROOT_NODE as h,ERROR_INVALID_NODE_ID as y,ERROR_MOVE_TOP_LEVEL_NODE as m,ERROR_MOVE_NONCANVAS_CHILD as g,ERROR_CANNOT_DRAG as N,ERROR_MOVE_TO_NONCANVAS_PARENT as E,ERROR_MOVE_INCOMING_PARENT as b,ERROR_MOVE_CANNOT_DROP as O,ERROR_MOVE_TO_DESCENDANT as C,ERROR_DUPLICATE_NODEID as k,ERROR_MOVE_OUTGOING_PARENT as j,getRandomId as T,ERROR_DESERIALIZE_COMPONENT_NOT_IN_RESOLVER as x,ERROR_NOT_IN_RESOLVER as P,useMethods as w,ERROR_RESOLVER_NOT_AN_OBJECT as D}from"@craftjs/utils";export{ROOT_NODE}from"@craftjs/utils";import I,{createContext as L,useContext as q,useMemo as S,useRef as R,useEffect as _,useState as z,Children as A,Fragment as F}from"react";import M from"tiny-invariant";import{isFunction as H,pickBy as W}from"lodash";import J from"lodash/cloneDeep";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var B=function(e,n){return(B=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])})(e,n)};function V(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function t(){this.constructor=e}B(e,n),e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}var X=function(){return(X=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e}).apply(this,arguments)};function Y(e,n){var t={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)n.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(t[r[o]]=e[r[o]])}return t}function G(){for(var e=0,n=0,t=arguments.length;n<t;n++)e+=arguments[n].length;var r=Array(e),o=0;for(n=0;n<t;n++)for(var a=arguments[n],d=0,i=a.length;d<i;d++,o++)r[o]=a[d];return r}var K=L(null),Q=function(){return q(K)},U=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return V(n,e),n.prototype.handlers=function(){return{connect:function(e,n){},select:function(e,n){},hover:function(e,n){},drag:function(e,n){},drop:function(e,n){},create:function(e,n,t){}}},n}(e),Z=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return V(n,e),n}(n),$=function(e,n){var t=e.currentTarget,r=n.getBoundingClientRect(),o=r.top,a=r.left,d=r.width,i=r.height;if(t){var s=document.createElement("div");s.style.position="fixed",s.style.left="-100%",s.style.top="-100%",s.style.width="100%",s.style.height="100%",s.style.pointerEvents="none";var u=n.cloneNode(!0);return u.style.position="absolute",u.style.width=d+"px",u.style.height=i+"px",u.style.left=a+"px",u.style.top=o+"px",s.appendChild(u),document.body.appendChild(s),e.dataTransfer.setDragImage(s,a,o),s}},ee=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.currentSelectedElementIds=[],n}return V(n,e),n.prototype.handlers=function(){var e=this,t=this.options.store;return{connect:function(n,r){return t.actions.setDOM(r,n),e.reflect((function(e){e.select(n,r),e.hover(n,r),e.drop(n,r)}))},select:function(n,r){var o=e.addCraftEventListener(n,"mousedown",(function(n){n.craft.stopPropagation(),e.options.store.actions.setNodeEvent("selected",r)}));return function(){t.actions.setNodeEvent("selected",null),o()}},hover:function(n,r){var o=e.addCraftEventListener(n,"mouseover",(function(e){e.craft.stopPropagation(),t.actions.setNodeEvent("hovered",r)}));return function(){t.actions.setNodeEvent("hovered",null),o()}},drop:function(r,o){var a=e.addCraftEventListener(r,"dragover",(function(e){e.craft.stopPropagation(),e.preventDefault()})),d=e.addCraftEventListener(r,"dragenter",(function(e){e.craft.stopPropagation(),e.preventDefault();var r=n.draggedElement;if(r){var a=r;r.rootNodeId&&(a=r.nodes[r.rootNodeId]);var d=t.query.getDropPlaceholder(a,o,{x:e.clientX,y:e.clientY});d&&(t.actions.setIndicator(d),n.indicator=d)}}));return function(){d(),a()}},drag:function(r,o){if(!t.query.node(o).isDraggable())return function(){};r.setAttribute("draggable","true");var a=e.addCraftEventListener(r,"dragstart",(function(e){e.craft.stopPropagation(),n.draggedElementShadow=$(e,t.query.node(o).get().dom),n.draggedElement=o})),d=e.addCraftEventListener(r,"dragend",(function(n){n.craft.stopPropagation(),e.dropElement((function(e,n){t.actions.move(e,n.parent.id,n.index+("after"===n.where?1:0))}))}));return function(){r.setAttribute("draggable","false"),a(),d()}},create:function(r,o,a){r.setAttribute("draggable","true");var d=e.addCraftEventListener(r,"dragstart",(function(e){e.craft.stopPropagation();var r=t.query.parseReactElement(o).toNodeTree();n.draggedElementShadow=$(e,e.currentTarget),n.draggedElement=r})),i=e.addCraftEventListener(r,"dragend",(function(n){n.craft.stopPropagation(),e.dropElement((function(e,n){t.actions.addNodeTree(e,n.parent.id,n.index+("after"===n.where?1:0)),a&&H(a.onCreate)&&a.onCreate(e)}))}));return function(){r.removeAttribute("draggable"),d(),i()}}}},n.prototype.dropElement=function(e){var t=this.options.store,r=n.draggedElement,o=n.draggedElementShadow,a=n.indicator;r&&a&&!a.error&&e(r,a.placement),o&&(o.parentNode.removeChild(o),n.draggedElementShadow=null),n.draggedElement=null,n.indicator=null,t.actions.setIndicator(null),t.actions.setNodeEvent("dragged",null)},n.indicator=null,n}(U);function ne(e,n,t,r){void 0===r&&(r=2);var o=0,a=0,d=0,i=0,s=e.where;return t?t.inFlow?(d=t.outerWidth,i=r,o="before"===s?t.top:t.bottom,a=t.left):(d=r,i=t.outerHeight,o=t.top,a="before"===s?t.left:t.left+t.outerWidth):n&&(o=n.top+n.padding.top,a=n.left+n.padding.left,d=n.outerWidth-n.padding.right-n.padding.left-n.margin.left-n.margin.right,i=r),{top:o+"px",left:a+"px",width:d+"px",height:i+"px"}}var te=L(null);function re(e){var n=q(te);M(n,t);var a=Q(),d=r(n,e),i=S((function(){return a&&o(a.connectors)}),[a]);return X(X({},d),{connectors:i,inContext:!!n,store:n})}var oe=function(e){var n=e.children,t=re((function(e){return{enabled:e.options.enabled,indicator:e.events.indicator,indicatorOptions:e.options.indicator,handlers:e.handlers,handlersFactory:e.options.handlers,hydrationTimestamp:e.nodes.ROOT&&e.nodes.ROOT._hydrationTimestamp}})),r=t.actions,o=t.indicator,i=t.indicatorOptions,s=t.store,u=t.handlers,c=t.handlersFactory,l=t.enabled,f=t.hydrationTimestamp,p=R(s);p.current=s;var v=R(u);return v.current=u,_((function(){return r.history.ignore().setState((function(e){return e.handlers=c(p.current)})),function(){v.current&&v.current.cleanup()}}),[r,c,f]),_((function(){u&&(l?u.enable():u.disable())}),[l,u]),u?I.createElement(K.Provider,{value:u},o&&I.createElement(a,{style:X(X({},ne(o.placement,d(o.placement.parent.dom),o.placement.currentNode&&d(o.placement.currentNode.dom),i.thickness)),{backgroundColor:o.error?i.error:i.success,transition:i.transition||"0.2s ease-in"}),parentDom:o.placement.parent.dom}),n):null},ae=I.createContext(null),de=function(e){var n=e.id,t=e.related,r=void 0!==t&&t,a=e.children,d=Q(),i=S((function(){return o({connect:function(e){return d.connectors.connect(e,n)},drag:function(e){return d.connectors.drag(e,n)}})}),[d,n]);return I.createElement(ae.Provider,{value:{id:n,related:r,connectors:i}},a)};function ie(e){var n=q(ae);M(n,i);var t=n.id,r=n.related,o=n.connectors,a=re((function(n){return t&&n.nodes[t]&&e&&e(n.nodes[t])})),d=a.actions,s=Y(a,["actions","query"]),u=S((function(){return{setProp:function(e,n){n?d.history.throttle(n).setProp(t,e):d.setProp(t,e)},setCustom:function(e,n){n?d.history.throttle(n).setCustom(t,e):d.setCustom(t,e)},setHidden:function(e){return d.setHidden(t,e)}}}),[d,t]);return X(X({},s),{id:t,related:r,inNodeContext:!!n,actions:u,connectors:o})}function se(e){var n=ie(e),t=n.id,r=n.related,o=n.actions,a=n.inNodeContext,d=n.connectors,i=Y(n,["id","related","actions","inNodeContext","connectors"]);return X(X({},i),{actions:o,id:t,related:r,setProp:function(e){return s("useNode().setProp()",{suggest:"useNode().actions.setProp()"}),o.setProp(e)},inNodeContext:a,connectors:d})}var ue=function(e){var n=e.render,t=se().connectors;return"string"==typeof n.type?(0,t.connect)((0,t.drag)(I.cloneElement(n))):n},ce=function(){var e=ie((function(e){return{type:e.data.type,props:e.data.props,nodes:e.data.nodes,hydrationTimestamp:e._hydrationTimestamp}})),n=e.type,t=e.props,r=e.nodes;return S((function(){var e=t.children;r&&r.length>0&&(e=I.createElement(I.Fragment,null,r.map((function(e){return I.createElement(fe,{id:e,key:e})}))));var o=I.createElement(n,t,e);return"string"==typeof n?I.createElement(ue,{render:o}):o}),[n,t,e.hydrationTimestamp,r])},le=function(e){var n=e.render,t=ie((function(e){return{hidden:e.data.hidden}})).hidden,r=re((function(e){return{onRender:e.options.onRender}})).onRender;return t?null:I.createElement(r,{render:n||I.createElement(ce,null)})},fe=function(e){return I.createElement(de,{id:e.id},I.createElement(le,{render:e.render}))},pe={is:"div",canvas:!1,custom:{},hidden:!1},ve={is:"type",canvas:"isCanvas"};function he(e){var n=e.id,t=e.children,r=Y(e,["id","children"]),o=X(X({},pe),r).is,a=re(),d=a.query,i=a.actions,s=ie((function(e){return{node:{id:e.id,data:e.data}}})),l=s.node,f=s.inNodeContext,p=z(null),v=p[0],h=p[1];return u((function(){M(!!n,c);var e=l.id,a=l.data;if(f){var s,u=a.linkedNodes&&a.linkedNodes[n]&&d.node(a.linkedNodes[n]).get();if(u&&u.data.type===o)s=u.id;else{var p=I.createElement(he,r,t),v=d.parseReactElement(p).toNodeTree();s=v.rootNodeId,i.history.ignore().addLinkedNodeFromTree(v,e,n)}h(s)}})),v?I.createElement(fe,{id:v}):null}var ye=function(){return s("<Canvas />",{suggest:"<Element canvas={true} />"})};function Canvas(e){var n=Y(e,[]);return _((function(){return ye()}),[]),I.createElement(he,X({},n,{canvas:!0}))}var me=function(e){var n=e.children,t=e.json,r=e.data,o=re(),a=o.actions,d=o.query,i=z(null),u=i[0],c=i[1];t&&s("<Frame json={...} />",{suggest:"<Frame data={...} />"});var f=R({initialChildren:n,initialData:r||t});return _((function(){var e=f.current,n=e.initialChildren,t=e.initialData;if(t)a.history.ignore().deserialize(t);else if(n){var r=I.Children.only(n),o=d.parseReactElement(r).toNodeTree((function(e,n){return n===r&&(e.id=l),e}));a.history.ignore().addNodeTree(o)}c(I.createElement(fe,{id:l}))}),[a,d]),u},ge=function(e){return Y(e,["addLinkedNodeFromTree","setDOM","setNodeEvent","replaceNodes","reset"])};function Ne(e){var n=re(e),t=n.connectors,r=n.actions,o=Y(n.query,["deserialize"]),a=n.store,d=Y(n,["connectors","actions","query","store"]),i=ge(r),s=S((function(){return X(X({},i),{history:X(X({},i.history),{ignore:function(){for(var e,n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return ge((e=i.history).ignore.apply(e,n))},throttle:function(){for(var e,n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return ge((e=i.history).throttle.apply(e,n))}})})}),[i]);return X({connectors:t,actions:s,query:o,store:a},d)}function Ee(e){return function(n){return function(t){var r=e?Ne(e):Ne();return I.createElement(n,X({},r,t))}}}function be(e){return function(n){return function(t){var r=se(e);return I.createElement(n,X({},r,t))}}}var Oe=function(e){return Object.fromEntries?Object.fromEntries(e):e.reduce((function(e,n){var t,r=n[0],o=n[1];return X(X({},e),((t={})[r]=o,t))}),{})},Ce=function(e,n){var t=n.name||n.displayName;if(n===Canvas)return"Canvas";if(e[t])return t;for(var r=0;r<Object.keys(e).length;r++){var o=Object.keys(e)[r];if(e[o]===n)return o}return"string"==typeof n?n:void 0},ke=function(e,n){return"string"==typeof e?e:{resolvedName:Ce(n,e)}},je=function(e,n){var t=e.type,r=e.isCanvas,o=e.props;return o=Object.keys(o).reduce((function(e,t){var r=o[t];return null==r?e:(e[t]="children"===t&&"string"!=typeof r?A.map(r,(function(e){return"string"==typeof e?e:je(e,n)})):r.type?je(r,n):r,e)}),{}),{type:ke(t,n),isCanvas:!!r,props:o}},Te=function(e,n){var t=e.type,r=e.props,o=e.isCanvas,a=Y(e,["type","props","isCanvas","name"]),d=je({type:t,isCanvas:o,props:r},n);return X(X({},d),a)};function xe(e,n){M("string"==typeof n,y);var t=e.nodes[n],r=function(n){return xe(e,n)};return{isCanvas:function(){return!!t.data.isCanvas},isRoot:function(){return t.id===l},isLinkedNode:function(){return t.data.parent&&r(t.data.parent).linkedNodes().includes(t.id)},isTopLevelNode:function(){return this.isRoot()||this.isLinkedNode()},isDeletable:function(){return!this.isTopLevelNode()},isParentOfTopLevelNodes:function(){return t.data.linkedNodes&&Object.keys(t.data.linkedNodes).length>0},isParentOfTopLevelCanvas:function(){return s("query.node(id).isParentOfTopLevelCanvas",{suggest:"query.node(id).isParentOfTopLevelNodes"}),this.isParentOfTopLevelNodes()},get:function(){return t},ancestors:function(n){return void 0===n&&(n=!1),function t(r,o,a){void 0===o&&(o=[]),void 0===a&&(a=0);var d=e.nodes[r];return d?(o.push(r),d.data.parent?((n||!n&&0===a)&&(o=t(d.data.parent,o,a+1)),o):o):o}(t.data.parent)},descendants:function(t,o){return void 0===t&&(t=!1),function n(a,d,i){return void 0===d&&(d=[]),void 0===i&&(i=0),(t||!t&&0===i)&&e.nodes[a]?("childNodes"!==o&&r(a).linkedNodes().forEach((function(e){d.push(e),d=n(e,d,i+1)})),"linkedNodes"!==o&&r(a).childNodes().forEach((function(e){d.push(e),d=n(e,d,i+1)})),d):d}(n)},linkedNodes:function(){return Object.values(t.data.linkedNodes||{})},childNodes:function(){return t.data.nodes||[]},isDraggable:function(n){try{var o=t;return M(!this.isTopLevelNode(),m),M(xe(e,o.data.parent).isCanvas(),g),M(o.rules.canDrag(o,r),N),!0}catch(e){return n&&n(e),!1}},isDroppable:function(n,o){var a="object"==typeof n&&!e.nodes[n.id],d=function(n){return"string"==typeof n?e.nodes[n]:n}(n),i=t;try{if("string"==typeof n&&M(!r(n).isTopLevelNode(),m),M(this.isCanvas(),E),M(i.rules.canMoveIn(d,i,r),b),M(d.rules.canDrop(i,d,r),O),a)return!0;var s=r(d.id).descendants(!0);M(!s.includes(i.id)&&i.id!==d.id,C);var u=d.data.parent&&e.nodes[d.data.parent];return M(u.data.isCanvas,g),M(u||!u&&!e.nodes[d.id],k),t!==u&&M(u.rules.canMoveOut(d,u,r),j),!0}catch(e){return o&&o(e),!1}},toSerializedNode:function(){return Te(t.data,e.options.resolver)},toNodeTree:function(e){var t=G([n],this.descendants(!0,e)).reduce((function(e,n){return e[n]=r(n).get(),e}),{});return{rootNodeId:n,nodes:t}},decendants:function(e){return void 0===e&&(e=!1),s("query.node(id).decendants",{suggest:"query.node(id).descendants"}),this.descendants(e)},isTopLevelCanvas:function(){return!this.isRoot()&&!t.data.parent}}}var Pe=function(e){return"string"==typeof e?e:e.name};function we(e,n){var t=e.data.type,r={id:e.id||T(),_hydrationTimestamp:Date.now(),data:X({type:t,name:Pe(t),displayName:Pe(t),props:{},custom:{},parent:null,isCanvas:!1,hidden:!1,nodes:[],linkedNodes:{}},e.data),related:{},events:{selected:!1,dragged:!1,hovered:!1},rules:{canDrag:function(){return!0},canDrop:function(){return!0},canMoveIn:function(){return!0},canMoveOut:function(){return!0}},dom:null};if(r.data.type===he||r.data.type===Canvas){var o=X(X({},pe),r.data.props);r.data.props=Object.keys(r.data.props).reduce((function(e,n){return Object.keys(pe).includes(n)?r.data[ve[n]||n]=o[n]:e[n]=r.data.props[n],e}),{}),r.data.name=Pe(t=r.data.type),r.data.displayName=Pe(t),r.data.type===Canvas&&(r.data.isCanvas=!0,ye())}n&&n(r);var a=t.craft;if(a&&(r.data.displayName=a.displayName||a.name||r.data.displayName,r.data.props=X(X({},a.props||a.defaultProps||{}),r.data.props),r.data.custom=X(X({},a.custom||{}),r.data.custom),null!=a.isCanvas&&(r.data.isCanvas=a.isCanvas),a.rules&&Object.keys(a.rules).forEach((function(e){["canDrag","canDrop","canMoveIn","canMoveOut"].includes(e)&&(r.rules[e]=a.rules[e])})),a.related)){var d={id:r.id,related:!0};Object.keys(a.related).forEach((function(e){r.related[e]=function(){return I.createElement(de,d,I.createElement(a.related[e]))}}))}return r}var De=function(e,n,t){var r=e.props,o=function(e,n){return"object"==typeof e&&e.resolvedName?"Canvas"===e.resolvedName?Canvas:n[e.resolvedName]:"string"==typeof e?e:null}(e.type,n);if(o){r=Object.keys(r).reduce((function(e,t){var o=r[t];return e[t]=null==o?null:"object"==typeof o&&o.resolvedName?De(o,n):"children"===t&&Array.isArray(o)?o.map((function(e){return"string"==typeof e?e:De(e,n)})):o,e}),{}),t&&(r.key=t);var a=X({},I.createElement(o,X({},r)));return X(X({},a),{name:Ce(n,a.type)})}},Ie=function(e,n){var t=e.type,r=Y(e,["type","props"]);M(void 0!==t&&"string"==typeof t||void 0!==t&&void 0!==t.resolvedName,x.replace("%displayName%",e.displayName).replace("%availableComponents%",Object.keys(n).join(", ")));var o=De(e,n),a=o.name;return{type:o.type,name:a,displayName:r.displayName||a,props:o.props,custom:r.custom||{},isCanvas:!!r.isCanvas,hidden:!!r.hidden,parent:r.parent,linkedNodes:r.linkedNodes||r._childCanvas||{},nodes:r.nodes||[]}},Le=function(e,n){var t,r;if(n.length<1)return(t={})[e.id]=e,t;var o=n.map((function(e){return e.rootNodeId})),a=X(X({},e),{data:X(X({},e.data),{nodes:o})}),d=((r={})[e.id]=a,r);return n.reduce((function(n,t){var r,o=t.nodes[t.rootNodeId];return X(X(X({},n),t.nodes),((r={})[o.id]=X(X({},o),{data:X(X({},o.data),{parent:e.id})}),r))}),d)},qe=function(e,n){return{rootNodeId:e.id,nodes:Le(e,n)}};function Se(e){var n=e&&e.options,t=function(){return Se(e)};return{getDropPlaceholder:function(n,r,o,a){if(void 0===a&&(a=function(n){return e.nodes[n.id].dom}),n!==r){var i="string"==typeof n&&e.nodes[n],s=e.nodes[r],u=t().node(s.id).isCanvas()?s:e.nodes[s.data.parent];if(u){var c=u.data.nodes||[],l=function(e,n,t,r){for(var o={parent:e,index:0,where:"before"},a=0,d=0,i=0,s=0,u=0,c=0,l=0,f=n.length;l<f;l++){var p=n[l];if(c=p.top+p.outerHeight,s=p.left+p.outerWidth/2,u=p.top+p.outerHeight/2,!(d&&p.left>d||i&&u>=i||a&&p.left+p.outerWidth<a))if(o.index=l,p.inFlow){if(r<u){o.where="before";break}o.where="after"}else r<c&&(i=c),t<s?(d=s,o.where="before"):(a=s,o.where="after")}return o}(u,c?c.reduce((function(n,t){var r=a(e.nodes[t]);if(r){var o=X({id:t},d(r));n.push(o)}return n}),[]):[],o.x,o.y),f=c.length&&e.nodes[c[l.index]],p={placement:X(X({},l),{currentNode:f}),error:!1};return i&&t().node(i.id).isDraggable((function(e){return p.error=e})),t().node(u.id).isDroppable(n,(function(e){return p.error=e})),p}}},getOptions:function(){return n},node:function(n){return xe(e,n)},getSerializedNodes:function(){var n=this,t=Object.keys(e.nodes).map((function(e){return[e,n.node(e).toSerializedNode()]}));return Oe(t)},serialize:function(){return JSON.stringify(this.getSerializedNodes())},parseReactElement:function(n){return{toNodeTree:function(r){var o=function(e,n){var t=e;return"string"==typeof t&&(t=I.createElement(F,{},t)),we({data:{type:t.type,props:X({},t.props)}},(function(e){n&&n(e,t)}))}(n,(function(n,t){var o=Ce(e.options.resolver,n.data.type);M(null!==o,P),n.data.displayName=n.data.displayName||o,n.data.name=o,r&&r(n,t)})),a=[];return n.props&&n.props.children&&(a=I.Children.toArray(n.props.children).reduce((function(e,n){return I.isValidElement(n)&&e.push(t().parseReactElement(n).toNodeTree(r)),e}),[])),qe(o,a)}}},parseSerializedNode:function(n){return{toNode:function(r){var o=Ie(n,e.options.resolver);M(o.type,P);var a="string"==typeof r&&r;return a&&s("query.parseSerializedNode(...).toNode(id)",{suggest:"query.parseSerializedNode(...).toNode(node => node.id = id)"}),t().parseFreshNode(X(X({},a?{id:a}:{}),{data:o})).toNode(!a&&r)}}},parseFreshNode:function(n){return{toNode:function(t){return we(n,(function(n){n.data.parent===h&&(n.data.parent=l);var r=Ce(e.options.resolver,n.data.type);M(null!==r,P),n.data.displayName=n.data.displayName||r,n.data.name=r,t&&t(n)}))}}},createNode:function(e,n){s("query.createNode("+e+")",{suggest:"query.parseReactElement("+e+").toNodeTree()"});var t=this.parseReactElement(e).toNodeTree(),r=t.nodes[t.rootNodeId];return n?(n.id&&(r.id=n.id),n.data&&(r.data=X(X({},r.data),n.data)),r):r},getState:function(){return e}}}var Re={nodes:{},events:{dragged:null,selected:null,hovered:null,indicator:null},handlers:null,options:{onNodesChange:function(){return null},onRender:function(e){return e.render},resolver:{},enabled:!0,indicator:{error:"red",success:"rgb(98, 196, 98)"},handlers:function(e){return new ee({store:e})}}},_e={methods:function(e,n){return X(X({},function(e,n){var t=function(n,t,o){var a=function(t,r){var o=n.nodes[t];e.nodes[t]=X(X({},o),{data:X(X({},o.data),{parent:r})}),o.data.nodes.length>0&&(delete e.nodes[t].data.props.children,o.data.nodes.forEach((function(e){return a(e,o.id)}))),Object.values(o.data.linkedNodes).forEach((function(e){return a(e,o.id)}))};if(a(n.rootNodeId,t),t){var d=r(t);if("child"!==o.type)d.data.linkedNodes[o.id]=n.rootNodeId;else{var i=o.index;null!=i?d.data.nodes.splice(i,0,n.rootNodeId):d.data.nodes.push(n.rootNodeId)}}else M(n.rootNodeId===l,"Cannot add non-root Node without a parent")},r=function(n){M(n,v);var t=e.nodes[n];return M(t,p),t},o=function(n){var t=e.nodes[n],r=e.nodes[t.data.parent];if(t.data.nodes&&G(t.data.nodes).forEach((function(e){return o(e)})),t.data.linkedNodes&&Object.values(t.data.linkedNodes).map((function(e){return o(e)})),r.data.nodes.includes(n)){var a=r.data.nodes;a.splice(a.indexOf(n),1)}else{var d=Object.keys(r.data.linkedNodes).find((function(e){return r.data.linkedNodes[e]===e}));d&&delete r.data.linkedNodes[d]}!function(e,n){Object.keys(e.events).forEach((function(t){e.events[t]&&e.events[t]===n&&(e.events[t]=null)}))}(e,n),delete e.nodes[n]};return{addLinkedNodeFromTree:function(e,n,a){var d=r(n).data.linkedNodes[a];d&&o(d),t(e,n,{type:"linked",id:a})},add:function(e,n,r){var o=[e];Array.isArray(e)&&(s("actions.add(node: Node[])",{suggest:"actions.add(node: Node)"}),o=e),o.forEach((function(e){var o;t({nodes:(o={},o[e.id]=e,o),rootNodeId:e.id},n,{type:"child",index:r})}))},addNodeTree:function(e,n,r){t(e,n,{type:"child",index:r})},delete:function(e){M(!n.node(e).isTopLevelNode(),f),o(e)},deserialize:function(e){var t="string"==typeof e?JSON.parse(e):e,r=Object.keys(t).map((function(e){var r=e;return e===h&&(r=l),[r,n.parseSerializedNode(t[e]).toNode((function(e){return e.id=r}))]}));this.replaceNodes(Oe(r))},move:function(t,r,o){var a=e.nodes[t],d=a.data.parent,i=e.nodes[r].data.nodes;n.node(r).isDroppable(a,(function(e){throw new Error(e)}));var s=e.nodes[d].data.nodes;s[s.indexOf(t)]="marked",i.splice(o,0,t),e.nodes[t].data.parent=r,s.splice(s.indexOf("marked"),1)},replaceNodes:function(n){this.clearEvents(),e.nodes=n},clearEvents:function(){this.setNodeEvent("selected",null),this.setNodeEvent("hovered",null),this.setNodeEvent("dragged",null),this.setIndicator(null)},reset:function(){this.clearEvents(),this.replaceNodes({})},setOptions:function(n){n(e.options)},setNodeEvent:function(n,t){var r=e.events[n];r&&t!==r&&(e.nodes[r].events[n]=!1),t?(e.nodes[t].events[n]=!0,e.events[n]=t):e.events[n]=null},setCustom:function(n,t){t(e.nodes[n].data.custom)},setDOM:function(n,t){e.nodes[n]&&(e.nodes[n].dom=t)},setIndicator:function(n){n&&(!n.placement.parent.dom||n.placement.currentNode&&!n.placement.currentNode.dom)||(e.events.indicator=n)},setHidden:function(n,t){e.nodes[n].data.hidden=t},setProp:function(n,t){M(e.nodes[n],p),t(e.nodes[n].data.props)},selectNode:function(e){this.setNodeEvent("selected",null!=e?e:null),this.setNodeEvent("hovered",null)}}}(e,n)),{setState:function(n){var t=Y(this,["history"]);n(e,t)}})},ignoreHistoryForActions:["setDOM","setNodeEvent","selectNode","clearEvents","setOptions","setIndicator"],normalizeHistory:function(e){Object.keys(e.events).forEach((function(n){var t=e.events[n];t&&!e.nodes[t]&&(e.events[n]=null)})),Object.keys(e.nodes).forEach((function(n){var t=e.nodes[n];Object.keys(t.events).forEach((function(n){t.events[n]&&e.events[n]&&e.events[n]!==t.id&&(t.events[n]=!1)}))}))}},ze=function(e){return w(_e,X(X({},Re),{options:X(X({},Re.options),e)}),Se)},Ae=function(e){var n=e.children,t=e.onRender,r=e.onNodesChange,o=e.resolver,a=e.enabled,d=e.indicator;void 0!==o&&M("object"==typeof o&&!Array.isArray(o),D);var i=S((function(){return W({onRender:t,onNodesChange:r,resolver:o,enabled:a,indicator:d},(function(e){return void 0!==e}))}),[a,d,r,t,o]),s=ze(i);return _((function(){s&&i&&s.actions.setOptions((function(e){Object.assign(e,i)}))}),[s,i]),_((function(){s.subscribe((function(e){return{json:s.query.serialize()}}),(function(){s.query.getOptions().onNodesChange(s.query)}))}),[s]),s?I.createElement(te.Provider,{value:s},I.createElement(oe,null,n)):null},Fe=function(e){var n=e.events,t=e.data,r=t.nodes,o=t.linkedNodes,a=Y(e,["events","data"]),d=we(J(e));return{node:e=X(X(X({},d),a),{events:X(X({},d.events),n),dom:e.dom||d.dom}),childNodes:r,linkedNodes:o}},Me=function(e,n){var t=n.nodes,r=Y(n,["nodes"]),o=e.nodes,a=Y(e,["nodes"]);expect(a).toEqual(r);var d=Object.keys(t).reduce((function(e,n){var r=Y(t[n],["_hydrationTimestamp","rules"]);return e[n]=r,e}),{}),i=Object.keys(o).reduce((function(e,n){var t=Y(o[n],["_hydrationTimestamp","rules"]);return e[n]=t,e}),{});expect(i).toEqual(d)},He=function(e){var n={},t=function(e){var r=Fe(e),o=r.node,a=r.childNodes,d=r.linkedNodes;n[o.id]=o,a&&a.forEach((function(e,r){var a=Fe(e),d=a.node,i=a.childNodes,s=a.linkedNodes;d.data.parent=o.id,n[d.id]=d,o.data.nodes[r]=d.id,t(X(X({},d),{data:X(X({},d.data),{nodes:i||[],linkedNodes:s||{}})}))})),d&&Object.keys(d).forEach((function(e){var r=Fe(d[e]),a=r.node,i=r.childNodes,s=r.linkedNodes;o.data.linkedNodes[e]=a.id,a.data.parent=o.id,n[a.id]=a,t(X(X({},a),{data:X(X({},a.data),{nodes:i||[],linkedNodes:s||{}})}))}))};return t(e),n},We=function(e){void 0===e&&(e={});var n=e.nodes,t=e.events;return X(X(X({},Re),e),{nodes:n?He(n):{},events:X(X({},Re.events),t||{})})};export{_e as ActionMethodsWithConfig,Canvas,U as CoreEventHandlers,ee as DefaultEventHandlers,Z as DerivedCoreEventHandlers,Ae as Editor,he as Element,oe as Events,me as Frame,fe as NodeElement,xe as NodeHelpers,de as NodeProvider,Se as QueryMethods,Ee as connectEditor,be as connectNode,He as createTestNodes,We as createTestState,pe as defaultElementProps,ye as deprecateCanvasComponent,Re as editorInitialState,ve as elementPropToNodeData,Me as expectEditorState,Ne as useEditor,ze as useEditorStore,Q as useEventHandler,se as useNode};
