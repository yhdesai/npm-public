import t,{applyPatches as e,enableMapSet as n,enablePatches as r,produceWithPatches as o}from"immer";import i from"lodash/isEqualWith";import a,{useMemo as s,useRef as c,useReducer as u,useCallback as l,useEffect as p,useState as f,cloneElement as d,isValidElement as h}from"react";import y from"shallowequal";import{nanoid as g}from"nanoid";import m from"tiny-invariant";import v from"react-dom";var b="ROOT",E="canvas-ROOT",O="Parent id cannot be ommited",R="Attempting to add a node with duplicated id",w="Node does not exist, it may have been removed",T='A <Element /> that is used inside a User Component must specify an `id` prop, eg: <Element id="text_element">...</Element> ',I="Placeholder required placement info (parent, index, or where) is missing",C="Node cannot be dropped into target parent",H="Target parent rejects incoming node",P="Current parent rejects outgoing node",D="Cannot move node that is not a direct child of a Canvas node",M="Cannot move node into a non-Canvas parent",x="A top-level Node cannot be moved",N="Root Node cannot be moved",k="Cannot move node into a descendant",A="The component type specified for this node does not exist in the resolver",L="The component specified in the <Canvas> `is` prop has additional Canvas specified in it's render template.",j="The node has specified a canDrag() rule that prevents it from being dragged",_="Invalid parameter Node Id specified",S="Attempting to delete a top-level Node",q="Resolver in <Editor /> has to be an object. For (de)serialization Craft.js needs a list of all the User Components. \n    \nMore info: https://craft.js.org/r/docs/api/editor#props",U="An Error occurred while deserializing components: Cannot find component <%displayName% /> in resolver map. Please check your resolver in <Editor />\n\nAvailable components in resolver: %availableComponents%\n\nMore info: https://craft.js.org/r/docs/api/editor#props",G="You can only use useEditor in the context of <Editor />. \n\nPlease only use useEditor in components that are children of the <Editor /> component.",Y="You can only use useNode in the context of <Editor />. \n\nPlease only use useNode in components that are children of the <Editor /> component.",W=function(t,e){return(W=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)},z=function(){return(z=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function B(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var i=arguments[e],a=0,s=i.length;a<s;a++,o++)r[o]=i[a];return r}var F={UNDO:"HISTORY_UNDO",REDO:"HISTORY_REDO",THROTTLE:"HISTORY_THROTTLE",IGNORE:"HISTORY_IGNORE",MERGE:"HISTORY_MERGE",CLEAR:"HISTORY_CLEAR"},J=function(){function t(){this.timeline=[],this.pointer=-1}return t.prototype.add=function(t,e){0===t.length&&0===e.length||(this.pointer=this.pointer+1,this.timeline.length=this.pointer,this.timeline[this.pointer]={patches:t,inversePatches:e,timestamp:Date.now()})},t.prototype.throttleAdd=function(t,e,n){if(void 0===n&&(n=500),0!==t.length||0!==e.length){if(this.timeline.length&&this.pointer>=0){var r=this.timeline[this.pointer],o=r.patches,i=r.inversePatches,a=r.timestamp;if((new Date).getTime()-a<n)return void(this.timeline[this.pointer]={timestamp:a,patches:B(o,t),inversePatches:B(e,i)})}this.add(t,e)}},t.prototype.merge=function(t,e){if(0!==t.length||0!==e.length)if(this.timeline.length&&this.pointer>=0){var n=this.timeline[this.pointer],r=n.inversePatches;this.timeline[this.pointer]={timestamp:n.timestamp,patches:B(n.patches,t),inversePatches:B(e,r)}}else this.add(t,e)},t.prototype.clear=function(){this.timeline=[],this.pointer=-1},t.prototype.canUndo=function(){return this.pointer>=0},t.prototype.canRedo=function(){return this.pointer<this.timeline.length-1},t.prototype.undo=function(t){if(this.canUndo()){var n=this.timeline[this.pointer].inversePatches;return this.pointer=this.pointer-1,e(t,n)}},t.prototype.redo=function(t){if(this.canRedo())return this.pointer=this.pointer+1,e(t,this.timeline[this.pointer].patches)},t}();function K(e,n,r,i){var a,f=s((function(){return new J}),[]),d=c([]),h=c();"function"==typeof e?a=e:(a=e.methods,d.current=e.ignoreHistoryForActions,h.current=e.normalizeHistory);var y=c(i);y.current=i;var g=s((function(){var e=h.current,n=d.current,i=y.current;return[function(s,c){var u,l=r&&Q(r,(function(){return s}),f),p=o(s,(function(t){var e,n;switch(c.type){case F.UNDO:return f.undo(t);case F.REDO:return f.redo(t);case F.CLEAR:return f.clear(),z({},t);case F.IGNORE:case F.MERGE:case F.THROTTLE:var r=c.payload,o=r[0],i=r.slice(1);(e=a(t,l))[o].apply(e,i);break;default:(n=a(t,l))[c.type].apply(n,c.payload)}})),d=p[0],h=p[1],y=p[2];return u=d,i&&i(d,s,{type:c.type,params:c.payload,patches:h},l,(function(t){var e=o(d,t);u=e[0],h=B(h,e[1]),y=B(e[2],y)})),[F.UNDO,F.REDO].includes(c.type)&&e&&(u=t(u,e)),B(n,[F.UNDO,F.REDO,F.IGNORE,F.CLEAR]).includes(c.type)||(c.type===F.THROTTLE?f.throttleAdd(h,y,c.config&&c.config.rate):c.type===F.MERGE?f.merge(h,y):f.add(h,y)),u},a]}),[f,a,r]),m=g[1],v=u(g[0],n),b=v[0],E=v[1],O=c();O.current=b;var R=s((function(){return r?Q(r,(function(){return O.current}),f):[]}),[f,r]),w=s((function(){var t=Object.keys(m(null,null)),e=d.current;return z(z({},t.reduce((function(t,e){return t[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return E({type:e,payload:t})},t}),{})),{history:{undo:function(){return E({type:F.UNDO})},redo:function(){return E({type:F.REDO})},clear:function(){return E({type:F.CLEAR})},throttle:function(n){return z({},t.filter((function(t){return!e.includes(t)})).reduce((function(t,e){return t[e]=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return E({type:F.THROTTLE,payload:B([e],t),config:{rate:n}})},t}),{}))},ignore:function(){return z({},t.filter((function(t){return!e.includes(t)})).reduce((function(t,e){return t[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return E({type:F.IGNORE,payload:B([e],t)})},t}),{}))},merge:function(){return z({},t.filter((function(t){return!e.includes(t)})).reduce((function(t,e){return t[e]=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return E({type:F.MERGE,payload:B([e],t)})},t}),{}))}}})}),[m]),T=l((function(){return O.current}),[]),I=s((function(){return new V(T)}),[T]);return p((function(){O.current=b,I.notify()}),[b,I]),s((function(){return{getState:T,subscribe:function(t,e,n){return I.subscribe(t,e,n)},actions:w,query:R,history:f}}),[w,R,I,T,f])}function Q(t,e,n){var r=Object.keys(t()).reduce((function(n,r){var o;return z(z({},n),((o={})[r]=function(){for(var n,o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];return(n=t(e()))[r].apply(n,o)},o))}),{});return z(z({},r),{history:{canUndo:function(){return n.canUndo()},canRedo:function(){return n.canRedo()}}})}n(),r();var V=function(){function t(t){this.subscribers=[],this.getState=t}return t.prototype.subscribe=function(t,e,n){var r=this,o=new X((function(){return t(r.getState())}),e,n);return this.subscribers.push(o),this.unsubscribe.bind(this,o)},t.prototype.unsubscribe=function(t){if(this.subscribers.length){var e=this.subscribers.indexOf(t);if(e>-1)return this.subscribers.splice(e,1)}},t.prototype.notify=function(){this.subscribers.forEach((function(t){return t.collect()}))},t}(),X=function(){function t(t,e,n){void 0===n&&(n=!1),this.collector=t,this.onChange=e,n&&this.collect()}return t.prototype.collect=function(){try{var t=this.collector();i(t,this.collected)||(this.collected=t,this.onChange&&this.onChange(this.collected))}catch(t){console.warn(t)}},t}(),Z=function(t){return window.getComputedStyle(t)},$=function(t){return{left:parseInt(Z(t).paddingLeft),right:parseInt(Z(t).paddingRight),bottom:parseInt(Z(t).paddingTop),top:parseInt(Z(t).paddingBottom)}},tt=function(t){return{left:parseInt(Z(t).marginLeft),right:parseInt(Z(t).marginRight),bottom:parseInt(Z(t).marginTop),top:parseInt(Z(t).marginBottom)}},et=function(t){var e=t.getBoundingClientRect(),n=e.x,r=e.y,o=e.top,i=e.left,a=e.bottom,s=e.right,c=e.width,u=e.height,l=tt(t),p=$(t);return{x:Math.round(n),y:Math.round(r),top:Math.round(o),left:Math.round(i),bottom:Math.round(a),right:Math.round(s),width:Math.round(c),height:Math.round(u),outerWidth:Math.round(c+l.left+l.right),outerHeight:Math.round(u+l.top+l.bottom),margin:l,padding:p,inFlow:t&&t.parentElement&&!!nt(t,t.parentElement)}},nt=function(t,e){var n=Z(t),r=Z(e);if(!(n.overflow&&"visible"!==n.overflow||"none"!==r.float||e&&"grid"===r.display||e&&"flex"===r.display&&"column"!==r["flex-direction"])){switch(n.position){case"static":case"relative":break;default:return}switch(t.tagName){case"TR":case"TBODY":case"THEAD":case"TFOOT":return!0}switch(n.display){case"block":case"list-item":case"table":case"flex":case"grid":return!0}}};function rt(t,e){var n=t.subscribe,r=t.getState,o=t.actions,i=t.query,a=c(!0),s=c(null),u=c(e);u.current=e;var d=l((function(t){return z(z({},t),{actions:o,query:i})}),[o,i]);a.current&&e&&(s.current=e(r(),i),a.current=!1);var h=f(d(s.current)),y=h[0],g=h[1];return p((function(){var t;return u.current&&(t=n((function(t){return u.current(t,i)}),(function(t){g(d(t))}))),function(){t&&t()}}),[d,i,n]),y}var ot,it=function(t){return void 0===t&&(t=10),g(t)},at=function(){function t(){this.elementIdMap=new WeakMap,this.registry=new Map}return t.prototype.getElementId=function(t){var e=this.elementIdMap.get(t);if(e)return e;var n=it();return this.elementIdMap.set(t,n),n},t.prototype.getConnectorId=function(t,e){return e+"--"+this.getElementId(t)},t.prototype.register=function(t,e){if(this.get(t,e.name)){if(y(e.required,this.get(t,e.name).required))return;this.get(t,e.name).disable()}var n=null;this.registry.set(this.getConnectorId(t,e.name),{required:e.required,enable:function(){n&&n(),n=e.connector(t,e.required,e.options)},disable:function(){n&&n()}}),this.registry.get(this.getConnectorId(t,e.name)).enable()},t.prototype.get=function(t,e){return this.registry.get(this.getConnectorId(t,e))},t.prototype.enable=function(){this.registry.forEach((function(t){t.enable()}))},t.prototype.disable=function(){this.registry.forEach((function(t){t.disable()}))},t.prototype.clear=function(){this.elementIdMap=new WeakMap,this.registry.clear()},t}();!function(t){t[t.HandlerDisabled=0]="HandlerDisabled",t[t.HandlerEnabled=1]="HandlerEnabled"}(ot||(ot={}));var st=function(){function t(t){this.registry=new at,this.subscribers=new Set,this.options=t}return t.prototype.listen=function(t){var e=this;return this.subscribers.add(t),function(){return e.subscribers.delete(t)}},t.prototype.disable=function(){this.registry.disable(),this.subscribers.forEach((function(t){t(ot.HandlerDisabled)}))},t.prototype.enable=function(){this.registry.enable(),this.subscribers.forEach((function(t){t(ot.HandlerEnabled)}))},t.prototype.cleanup=function(){this.disable(),this.subscribers.clear(),this.registry.clear()},t.prototype.addCraftEventListener=function(t,e,n,r){var o=function(r){(function(t,e,n){t.craft||(t.craft={stopPropagation:function(){},blockedEvents:{}});for(var r=t.craft&&t.craft.blockedEvents[e]||[],o=0;o<r.length;o++){var i=r[o];if(n!==i&&n.contains(i))return!0}return!1})(r,e,t)||(r.craft.stopPropagation=function(){r.craft.blockedEvents[e]||(r.craft.blockedEvents[e]=[]),r.craft.blockedEvents[e].push(t)},n(r))};return t.addEventListener(e,o,r),function(){return t.removeEventListener(e,o,r)}},Object.defineProperty(t.prototype,"connectors",{get:function(){var t=this,e=this.handlers();return Object.keys(e).reduce((function(n,r){var o;return z(z({},n),((o={})[r]=function(n,o,i){return t.registry.register(n,{required:o,name:r,options:i,connector:e[r]}),n},o))}),{})},enumerable:!0,configurable:!0}),t.prototype.derive=function(t,e){return new t(this,e)},t.prototype.createProxyHandlers=function(t,e){var n=[],r=t.handlers();return e(new Proxy(r,{get:function(t,e,o){return e in r==0?Reflect.get(t,e,o):function(t){for(var o=[],i=1;i<arguments.length;i++)o[i-1]=arguments[i];var a=r[e].apply(r,B([t],o));a&&n.push(a)}}})),function(){n.forEach((function(t){t()}))}},t.prototype.reflect=function(t){return this.createProxyHandlers(this,t)},t}(),ct=function(t){function e(e,n){var r=t.call(this,n)||this;return r.derived=e,r.options=n,r.unsubscribeParentHandlerListener=r.derived.listen((function(t){switch(t){case ot.HandlerEnabled:return r.enable();case ot.HandlerDisabled:return r.disable();default:return}})),r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}W(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(e,t),e.prototype.inherit=function(t){return this.createProxyHandlers(this.derived,t)},e.prototype.cleanup=function(){t.prototype.cleanup.call(this),this.unsubscribeParentHandlerListener()},e}(st);function ut(t,e){e&&("function"==typeof t?t(e):t.current=e)}function lt(t,e){var n=t.ref;return m("string"!=typeof n,"Cannot connect to an element with an existing string ref. Please convert it to use a callback ref instead, or wrap it into a <span> or <div>. Read more: https://facebook.github.io/react/docs/more-about-refs.html#the-ref-callback-attribute"),d(t,n?{ref:function(t){ut(n,t),ut(e,t)}}:{ref:e})}function pt(t){if("string"!=typeof t.type)throw new Error}function ft(t){return function(e){void 0===e&&(e=null);for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];if(!h(e)){if(!e)return;var o=e;return o&&t.apply(void 0,B([o],n)),o}var i=e;return pt(i),lt(i,t)}}function dt(t){return Object.keys(t).reduce((function(e,n){return e[n]=ft((function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return t[n].apply(t,e)})),e}),{})}var ht=function(t){var e=t.parentDom,n=a.createElement("div",{style:z({position:"fixed",display:"block",opacity:1,borderStyle:"solid",borderWidth:"1px",borderColor:"transparent",zIndex:99999},t.style)});return e&&e.ownerDocument!==document?v.createPortal(n,e.ownerDocument.body):n},yt=function(t){p(t,[])},gt=function(t,e){var n="Deprecation warning: "+t+" will be deprecated in future relases.",r=e.suggest,o=e.doc;r&&(n+=" Please use "+r+" instead."),o&&(n+="("+o+")"),console.warn(n)};export{E as DEPRECATED_ROOT_NODE,ct as DerivedEventHandlers,j as ERROR_CANNOT_DRAG,S as ERROR_DELETE_TOP_LEVEL_NODE,U as ERROR_DESERIALIZE_COMPONENT_NOT_IN_RESOLVER,R as ERROR_DUPLICATE_NODEID,L as ERROR_INFINITE_CANVAS,w as ERROR_INVALID_NODEID,_ as ERROR_INVALID_NODE_ID,I as ERROR_MISSING_PLACEHOLDER_PLACEMENT,C as ERROR_MOVE_CANNOT_DROP,H as ERROR_MOVE_INCOMING_PARENT,D as ERROR_MOVE_NONCANVAS_CHILD,P as ERROR_MOVE_OUTGOING_PARENT,N as ERROR_MOVE_ROOT_NODE,x as ERROR_MOVE_TOP_LEVEL_NODE,k as ERROR_MOVE_TO_DESCENDANT,M as ERROR_MOVE_TO_NONCANVAS_PARENT,O as ERROR_NOPARENT,A as ERROR_NOT_IN_RESOLVER,q as ERROR_RESOLVER_NOT_AN_OBJECT,T as ERROR_TOP_LEVEL_ELEMENT_NO_ID,G as ERROR_USE_EDITOR_OUTSIDE_OF_EDITOR_CONTEXT,Y as ERROR_USE_NODE_OUTSIDE_OF_EDITOR_CONTEXT,ot as EventHandlerUpdates,st as EventHandlers,F as HISTORY_ACTIONS,J as History,b as ROOT_NODE,ht as RenderIndicator,lt as cloneWithRef,Q as createQuery,gt as deprecationWarning,Z as getComputedStyle,et as getDOMInfo,tt as getDOMMargin,$ as getDOMPadding,it as getRandomId,nt as styleInFlow,rt as useCollector,yt as useEffectOnce,K as useMethods,dt as wrapConnectorHooks,ft as wrapHookToRecognizeElement};
